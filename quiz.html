<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take the Quiz | FRIENDS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="https://richinfo.co/richpartners/in-page/js/richads-ob.js?pubid=997197&siteid=381604" async></script>
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" style="text-decoration: none;">
                <div class="logo">
                    <span style="color: #FF4444;">F</span><span class="logo-dot" style="color: #FF9800;">‚Ä¢</span>
                    <span style="color: #2ECC71;">R</span><span class="logo-dot" style="color: #9C27B0;">‚Ä¢</span>
                    <span style="color: #4A90E2;">I</span><span class="logo-dot" style="color: #FF5722;">‚Ä¢</span>
                    <span style="color: #FFC107;">E</span><span class="logo-dot" style="color: #795548;">‚Ä¢</span>
                    <span style="color: #673AB7;">N</span><span class="logo-dot" style="color: #00BCD4;">‚Ä¢</span>
                    <span style="color: #E91E63;">D</span><span class="logo-dot" style="color: #8BC34A;">‚Ä¢</span>
                    <span style="color: #3F51B5;">S</span>
                </div>
            </a>
            <p id="quiz-title" class="tagline">Loading quiz...</p>
        </header>

        <div class="line"></div>

        <div id="quiz-container">
            <!-- Content loaded by JavaScript -->
        </div>

        <footer>
            <div class="footer-links">
                <a href="index.html"><i class='bx bx-home'></i> Home</a>
                <a href="privacy.html">Privacy</a>
                <a href="terms.html">Terms</a>
            </div>
        </footer>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALNlMLF-Fxu87Ge5yfhp2m1R-vU58XcLo",
            authDomain: "besides-sm.firebaseapp.com",
            projectId: "besides-sm",
            storageBucket: "besides-sm.firebasestorage.app",
            messagingSenderId: "897908486036",
            appId: "1:897908486036:web:e39140f75bec1b4d4de981",
            measurementId: "G-BB0NMVRFLY"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let quizData = null;
        let currentQuestion = 0;
        let userAnswers = {};
        let quizId = null;
        const ATTEMPT_KEY = 'friends_quiz_attempts';

        document.addEventListener('DOMContentLoaded', function() {
            // Get quiz ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            quizId = urlParams.get('quiz');
            
            if (!quizId) {
                window.location.href = 'index.html';
                return;
            }
            
            // Apply theme
            applyTheme();
            loadSavedNickname();
            
            // Check if already attempted
            if (hasAttemptedQuiz(quizId)) {
                showAlreadyAttempted();
                return;
            }
            
            // Load quiz data
            loadQuizData();
        });

        function applyTheme() {
            const themes = ['red', 'blue', 'green', 'orange', 'violet'];
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            document.body.classList.add('theme-' + randomTheme);
        }

        function loadSavedNickname() {
            const savedNickname = localStorage.getItem('friends_nickname');
            if (savedNickname) {
                const playerNameInput = document.getElementById('player-name');
                if (playerNameInput) {
                    playerNameInput.value = savedNickname;
                    // Auto-enable start button if name is valid
                    const startBtn = document.getElementById('start-quiz');
                    if (startBtn && savedNickname.length >= 2) {
                        startBtn.disabled = false;
                    }
                }
            }
        }

        function hasAttemptedQuiz(quizId) {
            const attempts = JSON.parse(localStorage.getItem(ATTEMPT_KEY) || '{}');
            return attempts[quizId] === true;
        }

        function markQuizAttempted(quizId) {
            const attempts = JSON.parse(localStorage.getItem(ATTEMPT_KEY) || '{}');
            attempts[quizId] = true;
            localStorage.setItem(ATTEMPT_KEY, JSON.stringify(attempts));
        }

        function showAlreadyAttempted() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="card" style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 40px; margin-bottom: 12px; color: var(--primary-color);">‚è∞</div>
                    <h2 style="margin-bottom: 10px;">One Attempt Only!</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                        You've already taken this quiz! Each friend can only attempt once to keep it fair. üòä
                    </p>
                    <a href="index.html" class="btn">
                        <i class='bx bx-home'></i> Create Your Own Quiz
                    </a>
                </div>
            `;
        }

        async function loadQuizData() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading quiz...</p>
                </div>
            `;
            
            try {
                const quizDoc = await db.collection('quizzes').doc(quizId).get();
                
                if (!quizDoc.exists) {
                    throw new Error('Quiz not found');
                }
                
                quizData = quizDoc.data();
                document.getElementById('quiz-title').textContent = `How well do you know ${quizData.ownerName}?`;
                
                showNameInput();
                
            } catch (error) {
                console.error('Error loading quiz:', error);
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 24px 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--primary-color);">üòï</div>
                        <h2 style="margin-bottom: 10px;">Quiz Not Found</h2>
                        <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                            This quiz link is invalid or has expired.
                        </p>
                        <a href="index.html" class="btn">
                            <i class='bx bx-home'></i> Create Your Own Quiz
                        </a>
                    </div>
                `;
            }
        }

        function showNameInput() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="card">
                    <h2 style="margin-bottom: 10px; font-size: 18px;"><i class='bx bx-user' style="color: var(--primary-color);"></i> What's your nickname?</h2>
                    <p style="color: #666; margin-bottom: 16px; font-size: 12px;">Enter your nickname to appear on the scoreboard</p>
                    
                    <div class="input-group">
                        <input type="text" id="player-name" class="input-field" placeholder="Your nickname" maxlength="20">
                    </div>
                    
                    <button id="start-quiz" class="btn" disabled>
                        <i class='bx bx-play'></i> Start Quiz
                    </button>
                </div>
            `;
            
            const nameInput = document.getElementById('player-name');
            const startBtn = document.getElementById('start-quiz');
            
            // Load saved nickname
            const savedNickname = localStorage.getItem('friends_nickname');
            if (savedNickname) {
                nameInput.value = savedNickname;
                if (savedNickname.length >= 2) {
                    startBtn.disabled = false;
                }
            }
            
            nameInput.addEventListener('input', function() {
                startBtn.disabled = this.value.trim().length < 2;
                // Save as user types
                if (this.value.trim().length >= 2) {
                    localStorage.setItem('friends_nickname', this.value.trim());
                }
            });
            
            startBtn.addEventListener('click', startQuiz);
        }

        function startQuiz() {
            const playerName = document.getElementById('player-name').value.trim();
            if (playerName.length < 2) return;
            
            userAnswers.playerName = playerName;
            userAnswers.playerId = generatePlayerId();
            showQuestion(0);
        }

        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showQuestion(index) {
            currentQuestion = index;
            const question = quizData.questions[index];
            
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3>Question ${index + 1} of 10</h3>
                        <span style="background: #f0f0f0; padding: 3px 10px; border-radius: 12px; font-weight: 600; color: var(--primary-color); font-size: 12px;">
                            ${Math.round(((index + 1) / 10) * 100)}%
                        </span>
                    </div>
                    
                    <div class="progress-container">
                        <div style="width: ${((index + 1) / 10) * 100}%;" class="progress-bar"></div>
                    </div>
                    
                    <div class="quiz-question">${question.text}</div>
                    
                    <div class="answer-options">
                        ${question.options.map((option, i) => `
                            <div class="answer-option ${userAnswers[index] === i ? 'selected' : ''}" data-index="${i}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="nav-buttons">
                        ${index > 0 ? `
                            <button id="prev-btn" class="btn btn-outline nav-btn btn-sm">
                                <i class='bx bx-chevron-left'></i> Prev
                            </button>
                        ` : '<div></div>'}
                        
                        ${index < 9 ? `
                            <button id="next-btn" class="btn nav-btn btn-sm" ${userAnswers[index] !== undefined ? '' : 'disabled'}>
                                Next <i class='bx bx-chevron-right'></i>
                            </button>
                        ` : `
                            <button id="submit-btn" class="btn nav-btn btn-sm" ${userAnswers[index] !== undefined ? '' : 'disabled'} style="background: #28a745;">
                                <i class='bx bx-check'></i> Submit
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            // Set up answer selection
            const options = container.querySelectorAll('.answer-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    // Deselect all
                    options.forEach(opt => opt.classList.remove('selected'));
                    // Select this one
                    option.classList.add('selected');
                    
                    // Enable next/submit button
                    const nextBtn = document.getElementById('next-btn');
                    const submitBtn = document.getElementById('submit-btn');
                    if (nextBtn) nextBtn.disabled = false;
                    if (submitBtn) submitBtn.disabled = false;
                    
                    // Store answer
                    userAnswers[index] = parseInt(option.dataset.index);
                });
            });
            
            // Navigation buttons
            if (index > 0) {
                document.getElementById('prev-btn').addEventListener('click', () => {
                    showQuestion(index - 1);
                });
            }
            
            if (index < 9) {
                document.getElementById('next-btn').addEventListener('click', () => {
                    showQuestion(index + 1);
                });
            } else {
                document.getElementById('submit-btn').addEventListener('click', submitQuiz);
            }
        }

        async function submitQuiz() {
            // Calculate score
            let score = 0;
            quizData.questions.forEach((question, index) => {
                if (userAnswers[index] !== undefined) {
                    const selectedOption = question.options[userAnswers[index]];
                    if (selectedOption === question.correctAnswer) {
                        score++;
                    }
                }
            });
            
            // Show loading
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Calculating your score...</p>
                </div>
            `;
            
            try {
                // Get player rank (count existing scores)
                const scoresSnapshot = await db.collection('scores').doc(quizId)
                    .collection('attempts').get();
                const totalPlayers = scoresSnapshot.size + 1;
                const playerRank = totalPlayers;
                
                // Save score to database with player ID and quiz ID
                const scoreData = {
                    name: userAnswers.playerName,
                    playerId: userAnswers.playerId,
                    quizId: quizId, // Store quiz ID with score
                    score: score,
                    rank: playerRank,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('scores').doc(quizId).collection('attempts').add(scoreData);
                
                // Mark as attempted
                markQuizAttempted(quizId);
                
                // Save player info to local storage with quiz ID
                savePlayerInfo(quizId, userAnswers.playerName, userAnswers.playerId);
                
                // Show results
                showResults(score, playerRank);
                
            } catch (error) {
                console.error('Error saving score:', error);
                showResults(score, 1); // Show results even if save fails
            }
        }

        function savePlayerInfo(quizId, name, playerId) {
            const players = JSON.parse(localStorage.getItem('friends_quiz_players') || '{}');
            players[quizId] = {
                name: name,
                playerId: playerId,
                date: new Date().toISOString()
            };
            localStorage.setItem('friends_quiz_players', JSON.stringify(players));
        }

        function showResults(score, rank) {
            const container = document.getElementById('quiz-container');
            const percentage = (score / 10) * 100;
            
            // Determine result message
            let emoji, message;
            if (score === 10) {
                emoji = 'üèÜ';
                message = 'BEST FRIEND!';
            } else if (score >= 7) {
                emoji = 'üòÑ';
                message = 'Close Friend!';
            } else if (score >= 5) {
                emoji = 'üëç';
                message = 'Good Friend!';
            } else {
                emoji = 'üòÖ';
                message = 'Getting There!';
            }
            
            const messages = [
                "Perfect score! You know them better than they know themselves! üéØ",
                "Almost perfect! You're clearly one of their closest friends! üëØ",
                "Excellent! You pay attention to the details that matter! ‚ú®",
                "Great job! You know them pretty well! üòä",
                "Good score! You know the important things! üëç",
                "Not bad! You're getting to know them better! ü§î",
                "Room for improvement! Keep learning about them! üìö",
                "Getting there! Maybe have more heart-to-heart talks! üí¨",
                "Early days! Every friendship starts somewhere! üå±",
                "Just starting! This is the beginning of your journey! üöÄ",
                "Surprise! Sometimes opposites attract the most! ü§∑‚Äç‚ôÇÔ∏è"
            ];
            
            const resultMessage = messages[10 - score] || "Thanks for playing!";
            
            container.innerHTML = `
                <div class="card" style="text-align: center;">
                    <div class="result-emoji">${emoji}</div>
                    <h2 style="margin-bottom: 8px;">${message}</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                        You scored ${score} out of 10 about ${quizData.ownerName}!
                    </p>
                    
                    <div class="score-circle">
                        <div class="score-main">${score}/10</div>
                        <div class="score-percentage">${percentage}%</div>
                    </div>
                    
                    <div style="margin: 16px 0; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                        <h4 style="margin-bottom: 6px; color: var(--primary-color);"><i class='bx bx-star'></i> Your Result</h4>
                        <p style="color: #666; font-size: 12px; margin-bottom: 8px;">
                            ${resultMessage}
                        </p>
                        <p style="color: var(--primary-color); font-weight: 600; font-size: 13px;">
                            <i class='bx bx-trophy'></i> You are #${rank} on the scoreboard!
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                        <a href="index.html" class="btn btn-sm" style="flex: 1;">
                            <i class='bx bx-plus'></i> Create My Quiz
                        </a>
                    </div>
                    
                    <button onclick="shareResult(${score})" class="btn btn-sm" style="background: #4267B2;">
                        <i class='bx bx-share-alt'></i> Share My Score
                    </button>
                </div>
            `;
        }

        function shareResult(score) {
            const message = `I scored ${score}/10 on ${quizData.ownerName}'s FRIENDS quiz! üèÜ Can you beat my score? ${window.location.origin}/quiz.html?quiz=${quizId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'FRIENDS Quiz Result',
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('Result copied! Share it with friends!');
                });
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
