<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard | FRIENDS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="https://richinfo.co/richpartners/in-page/js/richads-ob.js?pubid=997197&siteid=381604" async></script>
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" style="text-decoration: none;">
                <div class="logo" style="font-size: 32px;">Fâ€¢Râ€¢Iâ€¢Eâ€¢Nâ€¢Dâ€¢S</div>
            </a>
            <p id="scoreboard-title" class="tagline">Live Scoreboard</p>
        </header>

        <div class="line"></div>

        <div class="card">
            <div id="stats-container">
                <!-- Stats loaded by JavaScript -->
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 22px;"><i class='bx bx-trophy' style="color: red;"></i> Live Ranking</h2>
                <span id="total-players" style="background: #f0f0f0; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                    0 players
                </span>
            </div>
            
            <div id="scores-container">
                <!-- Scores loaded by JavaScript -->
            </div>
            
            <div style="margin-top: 30px;">
                <button id="refresh-btn" class="btn" style="margin-bottom: 10px;">
                    <i class='bx bx-refresh'></i> Refresh Scores
                </button>
                <button id="share-btn" class="btn" style="background: #666;">
                    <i class='bx bx-share-alt'></i> Challenge More Friends
                </button>
            </div>
        </div>

        <div class="line"></div>

        <footer>
            <div class="footer-links">
                <a href="index.html"><i class='bx bx-home'></i> Home</a>
                <a href="privacy.html">Privacy</a>
                <a href="terms.html">Terms</a>
            </div>
        </footer>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALNlMLF-Fxu87Ge5yfhp2m1R-vU58XcLo",
            authDomain: "besides-sm.firebaseapp.com",
            projectId: "besides-sm",
            storageBucket: "besides-sm.firebasestorage.app",
            messagingSenderId: "897908486036",
            appId: "1:897908486036:web:e39140f75bec1b4d4de981",
            measurementId: "G-BB0NMVRFLY"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let quizId = null;
        let quizOwner = null;
        let unsubscribe = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Get quiz ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            quizId = urlParams.get('quiz');
            
            if (!quizId) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load quiz info and scores
            loadQuizInfo();
            loadScores();
            
            // Set up buttons
            document.getElementById('refresh-btn').addEventListener('click', loadScores);
            document.getElementById('share-btn').addEventListener('click', shareQuiz);
        });

        async function loadQuizInfo() {
            try {
                const quizDoc = await db.collection('quizzes').doc(quizId).get();
                
                if (quizDoc.exists) {
                    const data = quizDoc.data();
                    quizOwner = data.ownerName;
                    document.getElementById('scoreboard-title').textContent = `${data.ownerName}'s Quiz Scoreboard`;
                    
                    // Load statistics
                    let totalScore = 0;
                    const scoresSnapshot = await db.collection('scores').doc(quizId)
                        .collection('attempts').get();
                    
                    scoresSnapshot.forEach(doc => {
                        totalScore += doc.data().score || 0;
                    });
                    
                    const totalPlayers = scoresSnapshot.size;
                    const avgScore = totalPlayers > 0 ? (totalScore / totalPlayers).toFixed(1) : 0;
                    
                    const statsHtml = `
                        <h3 style="margin-bottom: 20px; font-size: 20px;">ðŸ“Š Quiz Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: bold; color: red;">
                                    ${totalPlayers}
                                </div>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">Total Players</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: bold; color: red;">
                                    ${avgScore}/10
                                </div>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">Average Score</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('stats-container').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('Error loading quiz info:', error);
            }
        }

        async function loadScores() {
            const container = document.getElementById('scores-container');
            const refreshBtn = document.getElementById('refresh-btn');
            
            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading scores...</p>
                </div>
            `;
            
            // Disable refresh button temporarily
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Loading...';
            
            try {
                // Unsubscribe from previous listener if exists
                if (unsubscribe) {
                    unsubscribe();
                }
                
                // Get scores
                const scoresSnapshot = await db.collection('scores').doc(quizId)
                    .collection('attempts')
                    .orderBy('score', 'desc')
                    .orderBy('submittedAt', 'asc')
                    .get();
                
                const scores = [];
                scoresSnapshot.forEach(doc => {
                    const data = doc.data();
                    scores.push({
                        ...data,
                        submittedAt: data.submittedAt?.toDate() || new Date()
                    });
                });
                
                displayScores(scores);
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bx bx-refresh"></i> Refresh Scores';
                
            } catch (error) {
                console.error('Error loading scores:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px; color: red;">ðŸ˜•</div>
                        <h3 style="margin-bottom: 15px;">Error Loading Scores</h3>
                        <p style="color: #666; margin-bottom: 30px;">Please try again later</p>
                        <button onclick="loadScores()" class="btn">
                            <i class='bx bx-refresh'></i> Try Again
                        </button>
                    </div>
                `;
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bx bx-refresh"></i> Refresh Scores';
            }
        }

        function displayScores(scores) {
            const container = document.getElementById('scores-container');
            const totalPlayers = document.getElementById('total-players');
            
            if (scores.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px; color: red;">ðŸ“­</div>
                        <h3 style="margin-bottom: 15px;">No Scores Yet</h3>
                        <p style="color: #666; margin-bottom: 30px;">Be the first to take the quiz!</p>
                        <a href="quiz.html?quiz=${quizId}" class="btn">
                            <i class='bx bx-play'></i> Take the Quiz
                        </a>
                    </div>
                `;
                totalPlayers.textContent = "0 players";
                return;
            }
            
            totalPlayers.textContent = `${scores.length} player${scores.length !== 1 ? 's' : ''}`;
            
            let html = '';
            scores.forEach((score, index) => {
                const rank = index + 1;
                const timeAgo = getTimeAgo(score.submittedAt);
                
                html += `
                    <div class="score-item">
                        <div class="rank ${rank <= 3 ? `rank-${rank}` : ''}">
                            ${rank}
                        </div>
                        <div class="player-info">
                            <div class="player-name">
                                ${score.name}
                                ${score.name === quizOwner ? ' <span style="color: red;">ðŸ‘‘</span>' : ''}
                            </div>
                            <div style="color: #666; font-size: 13px; margin-top: 2px;">
                                ${timeAgo}
                            </div>
                        </div>
                        <div class="player-score">
                            ${score.score}/10
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
            
            return "just now";
        }

        function shareQuiz() {
            const quizLink = `${window.location.origin}/quiz.html?quiz=${quizId}`;
            const message = `Can you beat my score on ${quizOwner}'s FRIENDS quiz? ðŸ† ${quizLink} Challenge accepted? ðŸ˜Ž`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'FRIENDS Quiz Challenge',
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('Challenge copied! Share it with friends!');
                });
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
