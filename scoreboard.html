<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard | FRIENDS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="https://richinfo.co/richpartners/in-page/js/richads-ob.js?pubid=997197&siteid=381604" async></script>
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" style="text-decoration: none;">
                <div class="logo">
                    <span style="color: #FF4444;">F</span><span class="logo-dot" style="color: #FF9800;">‚Ä¢</span>
                    <span style="color: #2ECC71;">R</span><span class="logo-dot" style="color: #9C27B0;">‚Ä¢</span>
                    <span style="color: #4A90E2;">I</span><span class="logo-dot" style="color: #FF5722;">‚Ä¢</span>
                    <span style="color: #FFC107;">E</span><span class="logo-dot" style="color: #795548;">‚Ä¢</span>
                    <span style="color: #673AB7;">N</span><span class="logo-dot" style="color: #00BCD4;">‚Ä¢</span>
                    <span style="color: #E91E63;">D</span><span class="logo-dot" style="color: #8BC34A;">‚Ä¢</span>
                    <span style="color: #3F51B5;">S</span>
                </div>
            </a>
            <p id="scoreboard-title" class="tagline">Live Scoreboard</p>
        </header>

        <div class="line"></div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="scoreboard">üìä Scoreboard</div>
            <div class="tab" data-tab="history">üìú History</div>
        </div>

        <!-- Scoreboard Content -->
        <div id="scoreboard-content">
            <div class="card">
                <div id="stats-container">
                    <!-- Stats loaded by JavaScript -->
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 style="font-size: 18px;"><i class='bx bx-trophy' style="color: var(--primary-color);"></i> Live Ranking</h2>
                    <span id="total-players" style="background: #f0f0f0; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 12px;">
                        0 players
                    </span>
                </div>
                
                <div id="scores-container">
                    <!-- Scores loaded by JavaScript -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button id="refresh-btn" class="btn btn-sm" style="margin-bottom: 6px;">
                        <i class='bx bx-refresh'></i> Refresh
                    </button>
                    <button id="share-btn" class="btn btn-sm btn-outline">
                        <i class='bx bx-share-alt'></i> Challenge Friends
                    </button>
                </div>
            </div>
        </div>

        <!-- History Content -->
        <div id="history-content" style="display: none;">
            <div class="card">
                <h2 style="font-size: 18px; margin-bottom: 12px;"><i class='bx bx-history' style="color: var(--primary-color);"></i> Your Quiz History</h2>
                
                <div id="history-container">
                    <!-- History loaded by JavaScript -->
                </div>
                
                <p style="color: #666; font-size: 12px; text-align: center; margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                    <i class='bx bx-info-circle'></i> Click on any quiz to view its scoreboard
                </p>
            </div>
        </div>

        <div class="line"></div>

        <footer>
            <div class="footer-links">
                <a href="index.html"><i class='bx bx-home'></i> Home</a>
                <a href="privacy.html">Privacy</a>
                <a href="terms.html">Terms</a>
            </div>
            <p class="copyright">FRIENDS ¬© 2025 | Made with ‚ù§Ô∏è for fun by btem Ltd.</p>
        </footer>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALNlMLF-Fxu87Ge5yfhp2m1R-vU58XcLo",
            authDomain: "besides-sm.firebasestorage.app",
            projectId: "besides-sm",
            storageBucket: "besides-sm.firebasestorage.app",
            messagingSenderId: "897908486036",
            appId: "1:897908486036:web:e39140f75bec1b4d4de981",
            measurementId: "G-BB0NMVRFLY"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let quizId = null;
        let quizOwner = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Apply theme
            applyTheme();
            
            // Get quiz ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            quizId = urlParams.get('quiz');
            
            if (!quizId) {
                // No quiz ID - show history
                document.getElementById('scoreboard-content').style.display = 'none';
                document.getElementById('history-content').style.display = 'block';
                document.querySelector('[data-tab="history"]').classList.add('active');
                document.querySelector('[data-tab="scoreboard"]').classList.remove('active');
                loadHistory();
            } else {
                // Has quiz ID - load scoreboard
                loadQuizInfo();
                loadScores();
            }
            
            // Set up tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    if (tabName === 'scoreboard') {
                        document.getElementById('scoreboard-content').style.display = 'block';
                        document.getElementById('history-content').style.display = 'none';
                        if (quizId) {
                            loadQuizInfo();
                            loadScores();
                        }
                    } else {
                        document.getElementById('scoreboard-content').style.display = 'none';
                        document.getElementById('history-content').style.display = 'block';
                        loadHistory();
                    }
                });
            });
            
            // Set up buttons
            document.getElementById('refresh-btn').addEventListener('click', loadScores);
            document.getElementById('share-btn').addEventListener('click', shareQuiz);
        });

        function applyTheme() {
            const themes = ['red', 'blue', 'green', 'orange', 'violet'];
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            document.body.classList.add('theme-' + randomTheme);
        }

        async function loadQuizInfo() {
            try {
                const quizDoc = await db.collection('quizzes').doc(quizId).get();
                
                if (quizDoc.exists) {
                    const data = quizDoc.data();
                    quizOwner = data.ownerName;
                    document.getElementById('scoreboard-title').textContent = `${data.ownerName}'s Scoreboard`;
                    
                    // Load statistics
                    const scoresSnapshot = await db.collection('scores').doc(quizId)
                        .collection('attempts').get();
                    
                    let totalScore = 0;
                    scoresSnapshot.forEach(doc => {
                        totalScore += doc.data().score || 0;
                    });
                    
                    const totalPlayers = scoresSnapshot.size;
                    const avgScore = totalPlayers > 0 ? (totalScore / totalPlayers).toFixed(1) : 0;
                    
                    const statsHtml = `
                        <h3 style="margin-bottom: 12px; font-size: 16px;">üìä Quiz Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div style="text-align: center; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                                    ${totalPlayers}
                                </div>
                                <div style="color: #666; font-size: 11px; margin-top: 3px;">Total Players</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                                    ${avgScore}/10
                                </div>
                                <div style="color: #666; font-size: 11px; margin-top: 3px;">Average Score</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('stats-container').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('Error loading quiz info:', error);
                document.getElementById('stats-container').innerHTML = `
                    <div style="text-align: center; padding: 16px; color: #666; font-size: 12px;">
                        Unable to load statistics
                    </div>
                `;
            }
        }

        async function loadScores() {
            const container = document.getElementById('scores-container');
            const refreshBtn = document.getElementById('refresh-btn');
            
            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading scores...</p>
                </div>
            `;
            
            // Disable refresh button temporarily
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Loading...';
            
            try {
                // Get scores with quiz ID included (already stored with each score)
                const scoresSnapshot = await db.collection('scores').doc(quizId)
                    .collection('attempts')
                    .orderBy('score', 'desc')
                    .orderBy('submittedAt', 'asc')
                    .get();
                
                const scores = [];
                scoresSnapshot.forEach(doc => {
                    const data = doc.data();
                    scores.push({
                        ...data,
                        id: doc.id,
                        quizId: data.quizId || quizId, // Use stored quizId or fallback
                        submittedAt: data.submittedAt?.toDate() || new Date()
                    });
                });
                
                displayScores(scores);
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bx bx-refresh"></i> Refresh';
                
            } catch (error) {
                console.error('Error loading scores:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 24px 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--primary-color);">üòï</div>
                        <h3 style="margin-bottom: 10px; font-size: 16px;">Error Loading Scores</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 12px;">Please check your connection</p>
                        <button onclick="loadScores()" class="btn btn-sm">
                            <i class='bx bx-refresh'></i> Try Again
                        </button>
                    </div>
                `;
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bx bx-refresh"></i> Refresh';
            }
        }

        function displayScores(scores) {
            const container = document.getElementById('scores-container');
            const totalPlayers = document.getElementById('total-players');
            
            if (scores.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 24px 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--primary-color);">üì≠</div>
                        <h3 style="margin-bottom: 10px; font-size: 16px;">No Scores Yet</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 12px;">Be the first to take this quiz!</p>
                        <a href="quiz.html?quiz=${quizId}" class="btn btn-sm">
                            <i class='bx bx-play'></i> Take the Quiz
                        </a>
                    </div>
                `;
                totalPlayers.textContent = "0 players";
                return;
            }
            
            totalPlayers.textContent = `${scores.length} player${scores.length !== 1 ? 's' : ''}`;
            
            let html = '';
            scores.forEach((score, index) => {
                const rank = index + 1;
                const timeAgo = getTimeAgo(score.submittedAt);
                const isOwner = score.name === quizOwner;
                
                html += `
                    <div class="score-item">
                        <div class="rank ${rank <= 3 ? `rank-${rank}` : ''}">
                            ${rank}
                        </div>
                        <div class="player-info">
                            <div class="player-name">
                                ${score.name}
                                ${isOwner ? ' <span style="color: var(--primary-color);">üëë</span>' : ''}
                            </div>
                            <div class="player-time">
                                ${timeAgo}
                            </div>
                        </div>
                        <div class="player-score">
                            ${score.score}/10
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + " hr" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + " min" + (interval === 1 ? "" : "s") + " ago";
            
            return "just now";
        }

        function loadHistory() {
            const container = document.getElementById('history-container');
            const history = JSON.parse(localStorage.getItem('friends_quiz_history') || '[]');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 24px 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--primary-color);">üìù</div>
                        <h3 style="margin-bottom: 10px; font-size: 16px;">No Quiz History</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 12px;">Create your first quiz to see it here!</p>
                        <a href="create.html" class="btn btn-sm">
                            <i class='bx bx-plus'></i> Create Quiz
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            history.forEach((quiz, index) => {
                const date = new Date(quiz.date);
                const emojis = ['üë§', 'üéØ', 'üèÜ', '‚≠ê', '‚ú®'];
                const emoji = emojis[index % emojis.length];
                
                html += `
                    <div class="history-item" onclick="viewQuiz('${quiz.id}')">
                        <div class="history-emoji">${emoji}</div>
                        <div class="history-info">
                            <div class="history-name">${quiz.name}'s Quiz</div>
                            <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <i class='bx bx-chevron-right' style="color: #ccc;"></i>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function viewQuiz(quizId) {
            window.location.href = `scoreboard.html?quiz=${quizId}`;
        }

        function shareQuiz() {
            if (!quizId) {
                showNotification('Create a quiz first to share!');
                return;
            }
            
            const quizLink = `${window.location.origin}/quiz.html?quiz=${quizId}`;
            const message = `Can you beat my score on ${quizOwner}'s FRIENDS quiz? üèÜ ${quizLink} Challenge accepted? üòé`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'FRIENDS Quiz Challenge',
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('Challenge copied! Share it with friends!');
                });
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
